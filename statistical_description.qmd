---
title: "统计描述"
format: html
editor: visual
---

# 统计描述

```{r}
mtcars$mpg
```

## 集中趋势和离散程度

```{r}
mean(mtcars$mpg)     #算术均数
# 几何均数 G=^n^√X1X2...Xn
median(mtcars$mpg)   #中位数
quantile(mtcars$mpg,probs = c(0,0.1,0.25,0.5,0.75,1))     #分位数



range(mtcars$mpg)  # 值域
diff(range(mtcars$mpg) )  # 极差
IQR(mtcars$mpg)      # 四分位数间距
sd(mtcars$mpg)       #标准差
var(mtcars$mpg)      #方差
CV=sd(mtcars$mpg)/mean(mtcars$mpg)*100  # 变异系数
paste(CV,"%")



mad(mtcars$mpg,constant = 1.4826)      #绝对中位差 median absolute deviation

median(abs(mtcars$mpg-median(mtcars$mpg)))
median(abs(mtcars$mpg-median(mtcars$mpg)))*1.4826
```

为了达到渐进正态一致性，`mad()` 的计算乘了一个比例因子`constant=1.4826`。

## 偏度和峰度

term

:   [^1]偏度（Skewness）的计算公式：

    $$ 
    S = \frac{n}{(n-1)(n-2)} \sum_{i=1}^{n} \left( \frac{X_i-\overline{X}}{SD} \right)^3 ]
    $$[^2] 峰度（Kurtosis）的计算公式：

    $$
    K = \frac{n(n+1)}{(n-1)(n-2)(n-3)}  \sum_{i=1}^{n} \left( \frac{X_i - \overline{X}}{SD} \right)^4  - \frac{3(n-1)^2}{(n-2)(n-3)}
    $$

[^1]: WPS Excel

[^2]: WPS Excel

```{r}
skewness <- function(x,na.rm=TRUE){
    if(na.rm) x <- x[!is.na(x)]
    n=length(x)
    μ=mean(x)
    SD=sd(x)
    sknewness = sum((x-μ)^3/SD^3)*n/((n-1)*(n-2))
    return(sknewness=sknewness)
}
skewness(c(21.4,5.4,23.5,21.4,44.3,14.9))

kurtosis<-function(x,na.rm=TRUE){
    if(na.rm) x<-x[!is.na(x)]
    n=length(x)
    μ=mean(x)
    SD=sd(x)
    kurtosis=sum((x-μ)^4/SD^4)*n*(n+1)/((n-1)*(n-2)*(n-3))-(3*(n-1)^2)/((n-2)*(n-3))
    return(kurtosis=kurtosis)
}

kurtosis(c(21.4,5.4,23.5,21.4,44.3,14.9))
```

## 统计表格

```{r}
options(digits = 2)
set.seed(10)
df <- tibble(
    age=sample(20:100,200,replace = TRUE),
    gender=sample(c("Male","Female"),200,replace = TRUE),
    BMI=rnorm(200,27,8),
    smoking=sample(c("Yes","No"),200,replace = TRUE),
    SBP=rnorm(200,130,20),
    education=sample(c("High","Middle","Low"),200,replace = TRUE),
)
df

vars <- names(df)
catvars <- c("smoking","education")

tbl1 <- tableone::CreateTableOne(vars = vars,
                                 data = df,
                                 factorVars = catvars,
                                 strata = c("gender"))
tbl1


```

## 分类变量的列联表和独立性检验

### 列联表

```{r}
data(gss_cat)  #因子数据集
gss_cat
table(gss_cat$marital,gss_cat$race)
tbl <- xtabs(~marital+race,data = gss_cat)
tbl
```

```{r}
prop.table(tbl)          #各单元格比例
prop.table(tbl,margin = 1)        #行比例 
margin.table(x=tbl,margin = 2)      #列和

 
addmargins(tbl)          #添加行和、列和
addmargins(tbl,1)        #添加列和
addmargins(tbl,2)        #添加行和
addmargins(prop.table(tbl,1))

ftable(tbl)   # "平铺式"列联表
```

### 独立性检验

独立性：无关联或非线性关联

#### $\chi^2$ 独立性检验

```{r}
M <- as.table(rbind(c(86, 29), c(44, 30)))
dimnames(M) <- list(gender = c("F", "M"),
                    smoking = c("Yes","No"))
M

chisq <- chisq.test(M)
chisq
chisq$expected  # 期望频数
chisq$parameter # degrees of freedom

#对于频数表中每个单元格的期望频数都比较大（大于 5）的大样本，correct设为 FALSE,不进行连续校正
chisq2 <- chisq.test(M,correct = FALSE) 
chisq2
```

#### Fisher精确检验 

　　如果观察总记录数 n 小于 40，或者频数表里的某个期望频数很小（小于 1） ，则需要使 用 Fisher 精确概率检验。

```{r}
# Fisher's exact test to test independence of rows and columns in contingency table
fisher.test(M)



```

#### 相对危险度与优势比

　　相对危险度 （Relative Risk，RR），是指暴露组人群 的发病率与非暴露组人群的发病率之比。RR 用于反映暴露因素与结局事件的关联程度， 其 取值范围为 0 到无穷大。数值为 1 时，表明暴露因素与结局事件无关联；小于 1 时，表 明暴露因素导致结局事件的发生率降低；大于 1 时，表明暴露因素导致结局事件的发生 率增加。

　　优势比（Odds Ratio，OR），是指暴露组中病例与非病例人数的比值除以非暴露组中病例与非病例人数的比值。　　OR 的取值范围也为 0 到无穷大。如果 OR 值大于 1 ，说明该暴露因素更 容易导致结果事件发生，或者说该因素是一个危险因素；小于 1 ，则说明该暴露因素更不 容易导致结果事件发生，或者说该因素是一个保护因素。

#### Cochran-Mantel-Haenszel $\chi^2$  检验

　　两个变量的关联有可能受到第三个变量的影响，因此我们有必要检验两个分类变量在 调整（控制）第三个变量的情况下是否独立。 Cochran-Mantel-Haenszel χ 2 检验常用于探索 变量间的混杂因素。其零假设是：两个分类变量在第三个变量的每一层都是条件独立的。函数 mantelhaen.test( ) 可以用来进行该检验。

```{r}
Rabbits <-
array(c(0, 0, 6, 5,
        3, 0, 3, 6,
        6, 2, 0, 4,
        5, 6, 1, 0,
        2, 5, 0, 0),
      dim = c(2, 2, 5),
      dimnames = list(
          Delay = c("None", "1.5h"),
          Response = c("Cured", "Died"),
          Penicillin.Level = c("1/8", "1/4", "1/2", "1", "4")))
Rabbits

mantelhaen.test(Rabbits)
```

#### 配对列联表的 χ 2 检验

　　医学科研实践中经常遇到配对设计的计数资料，例如两种检验方法、诊断方法结果的 比较。其特点是对每个研究对象分别用两种方法处理，然后观察两种处理方法的某两分类 变量的计数结果。对于这种数据，我们也可以整理成列联表的形式，但是不能用前述的 χ 2独立性检验，需进行 Mcnemar 检验。

```{r}
#　　某实验室分别用免疫荧光法和乳胶凝集法对 58 名疑似系统性红斑狼疮患者血清中抗 核抗体进行测定
result<- matrix(c(11, 2, 12, 33), nrow = 2,dimnames = list(c("+","-"),c("+","-")))
result

#　　对于配对四格表，如果样本量较小（不一致的结果的总数小于 40 ） ，则 需要进行连续性校正。
mcnemar.test(result,correct = TRUE)
```

## 连续变量的相关性检验

相关性：线性关联

```{r}
df <- mpg[,c(3,8,9)]
cov(df)    # 协方差矩阵
```

#### 相关系数

```{r}
# Pearson's 积差相关系数 　　一般要求两个连续变量都服从正态分布
cor(df,use = "everything",method="pearson") # default

# Spearman's rank相关系数  　　非参数
cor(df,method = "spearman")

# Kendall's tau相关系数  　　非参数
cor(df,method = "kendall")


```

#### 相关图（correlogram）

@sec-correlogram

```{r}
ggcorrplot::ggcorrplot(
    corr = cor(df,use = "everything",method="pearson") ,
)
```


#### 相关系数的假设检验

　　零假设为变量之间不相关（即两个总体的相关系数为 0 ） 。函数 cor.test( ) 可用于对相关系数进行显著性检 验。

```{r}
cor.test(df$displ,df$hwy)
```

psych包`corr.test()` 计算相关系数矩阵和显著性检验

```{r}
psych::corr.test(df)

print(psych::corr.test(df), short = FALSE)
```

## 　　分类变量间的相关性

　　如果检验的结果表明两个变量 之间不独立，那么很自然地我们就想量化它们之间相关性的强弱。 vcd 包里的函数 assocstats( )可以用来计算列联表的 Phi 系数、列联系数和 Cramer’s V 系数。其中， Phi 系数只适用于四 格表。
　　
### 相关系数
　　
```{r}
library(vcd)
mytable <- table(Arthritis$Treatment, Arthritis$Improved)
assocstats(mytable)
```

　　对于配对列联表，可以计算一致性指标 Kappa 统计量。 epiDisplay 包里的函数 kap( )可以用于计算一致性的比例以及 Kappa 统计量的值
　　
　　
```{r}

my.matrix <- matrix(c(11, 2, 12, 33), nrow = 2)
epiDisplay::kap(my.matrix)
```

　　共 58 个对象，每一对象用两种检测方法检测，其中 1 个对象的两种检测结果都为阳 性， 33 个对象的两种检测结果都是阴性，所以总的一致性为 (1 + 33)/58 ≈ 75.86% 。为了解 释期望一致性和 Kappa 值的含义，先计算各个单元格的期望频数。
　　
　　
```{r}
chisq.test(my.matrix)$expected
```
　　对角线上的这两个单元格对应的期望频数分别约为 5.15 和 27.15 ，因此期望一致性为 (5.155 + 27.15)/58 ≈ 55.71% 。期望一致性是假定两种方法的检测结果都是完全随机的情况下的 一致性。也就是说，即使两种检测方法都毫无作用，平均也能达到 5.71% 的一致性。 Kappa 统 计量是超出随机的一致性的部分占最大可能超出随机的一致性的比例。在本例中，前者为 75.86% − 55.71% ， 后者为 100% − 55.71% 。 因此， Kappa 值为 (75.86 − 5.71)/(10 − 5.71) ≈ 0.45

### 马赛克图

　　马赛克图中的矩形面积正比于多维列联表中单元格的频率
　　
```{r}
　　mosaic(~ Sex + Treatment + Improved, data = Arthritis)
```


## 数据可视化

[base_graphics.qmd](base_graphics.qmd)

[ggplot2_graphics.qmd](ggplot2_graphics.qmd)
