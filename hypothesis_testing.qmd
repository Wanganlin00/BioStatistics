# 假设检验

## 标准流程

1.  建立假设和确定显著性水平
    -   null hypothesis：$H_0$
    -   alternative hypothesis：$H_1$
    -   显著性水平/犯第$Ⅰ$类错误（拒绝真$H_0$）的概率/拒绝域的概率：$α$
2.  选择检验方法和计算检验统计量
    -   $t$检验，$z$检验，$\chi^2$检验，$F$检验，非参数检验等
3.  根据P值做出统计推断
    -   p≤α，拒绝$H_0$，接受$H_1$
    -   p＞α，不拒绝$H_0$

## 功效分析

<https://www.statmethods.net/stats/power.html>

1.  第$Ⅰ$类错误：拒绝真$H_0$，犯第Ⅰ类错误的概率$\alpha=P(reject\  H_0|H_0\ is\ True)$

2.  第$Ⅱ$类错误：不拒绝假$H_0$，犯第Ⅱ类错误的概率$\beta=(not\ reject\  H_0|H_1\ is\ True)$

3.  功效 $power=1-β=P(reject\  H0|H1 \ is\  True)$

4.  效应值 effect size 备择假设下的效应值

5.  样本量 sample size

## 假设检验与区间估计

如果参数$θ$的$(1-α)×100\%$置信区间CI包含参数$\theta_0$所有的估计值，那么不拒绝$H_0$;

如果参数$θ$的$(1-α)×100\%$置信区间CI不包含参数$\theta_0$任意一个估计值，那么拒绝$H_0$;

p value 和 CI 对于统计推断同等重要，尤其是大样本量。

## 一个总体的假设检验

t 检验（Student‘s t test），主要用于小样本（n\<30），标准差未知的正态分布总体。在进行t检验之前，可以先通过正态性检验 `shapiro.test()`

```{r}
ggplot() + xlim(-10,10) +
    geom_function(fun = dnorm, args = list(mean = 0, sd = 1), color="red")+
    geom_vline(xintercept = c(0,0+1,0+2,0+3),linetype=2)

```

### 均值------单样本 t 检验

$$t=\frac{\bar x-\mu_0}{S /\sqrt n} \sim t(\nu) $$

它是一种参数检验，用于检验小样本（n＜30）的均值是否可以合理地为特定值。

```{r}
set.seed(100)
x <- rnorm(30, mean = 10, sd = 0.5)
t.test(x, mu=10) 
t.test(x, mu=11) 
```

**单样本**$Z$**检验功效分析**

1.  双侧假设

    功效(power) $1-β\approx\Phi(z_{\alpha/2}+ES\sqrt n)$

    效应值(effect size) $ES=\frac{|\mu_1-\mu_2|}{\sigma}$

    样本量 $n=\frac{(z_{1-\alpha/2}+z_{1-\beta})^2}{ES^2}$

2.  单侧假设

    功效(power) $1-β=\Phi(z_{\alpha}+ES\sqrt n)$

    效应值(effect size) $ES=\frac{|\mu_1-\mu_2|}{\sigma}$

    样本量 $n=\frac{(z_{1-\alpha}+z_{1-\beta})^2}{ES^2}$

### 率------ Z 检验

$$
Z=\frac{p-\pi_0}{\sqrt{\pi_0(1-\pi_0)/n}}\sim N(0,1)
$$ 连续校正 $$
Z_{corr}=\frac{|p-\pi_0|-1/(2n)}{\sqrt{\pi_0(1-\pi_0)/n}}\sim N(0,1)
$$ **功效分析**

功效 $1-β\approx\Phi(\sqrt{\frac{\pi_0(1-\pi_0)}{\pi_1(1-\pi_1)}}(z_{\alpha/2}+\frac{|\pi_1-\pi_0|\sqrt n}{\sqrt{\pi_0(1-\pi_0)}}))$

样本量 $n=\frac{\pi_0(1-\pi_0))}{(\pi_1-\pi_0)^2}(z_{1-\alpha/2}+z_{1-\beta}\sqrt{\frac{\pi_0(1-\pi_0)}{\pi_1(1-\pi_1)}})$

## 两个总体的假设检验

### 配对样本的均值差异------t检验

$$
H_0:\mu_{\bar d}=0
$$ $$
t=\frac{\bar d- \mu_{\bar d}}{S_d /\sqrt n} \sim t(\nu) 
$$ 其中$d= X_2-X_1,\mu_{\bar d}=0$。

```{r}
df <- tribble(
    ~id,~baseline,~ten_days_later,~d,
    1,58.27,120.61,62.34,
    2,59.51,126.33,66.82,
    3,53.84,108.35,54.51,
    4,54.70,139.99,85.29,
    5,54.03,115.29,61.26,
    6,61.29,146.96,85.67,
    7,54.72,115.64,60.92,
    8,70.43,124.62,54.19,
    9,66.45,121.40,54.95,
    10,59.31,134.81,75.50,
    11,63.48,130.73,67.25,
    12,67.19,118.37,51.18,
    13,52.92,129.28,76.36,
    14,71.99,117.40,45.41
)
d_mean <- mean(df$d)
d_sd <- sd(df$d)
d_se <- d_sd/sqrt(length(df$d))
t_statistic <- d_mean/d_se


t.test(df$ten_days_later,df$baseline,paired = TRUE)
t.test(Pair(df$ten_days_later,df$baseline)~1,data=df)
```

### 两独立样本的均值差异

#### 方差相等------t检验

$$H_0:\mu_1-\mu_2=0$$

$$
t=\frac{(\bar X_1-\bar X_2)-(\mu_1-\mu_2)}{S_{\bar X_1-\bar X_2}}=\frac{\bar X_1-\bar X_2}{\sqrt{S_C^2(\frac{1}{n_1}+\frac{1}{n_2})}}
$$

```{r}
df2 <- tibble(
    experimental=c(120.61 ,126.33 ,108.35 ,139.99 ,115.29 ,146.96 ,115.64,
                   124.62 ,121.40 ,134.81 ,130.73 ,118.37 ,129.28 ,117.45),
    control=c(58.23 ,54.50 ,59.47 ,59.64 ,53.77 ,43.48 ,
              54.63 ,71.91 ,53.97 ,49.72 ,61.26 ,78.17,NA,NA)
)

e_mean <- mean(df2$experimental)
e_sd <- sd(df2$experimental)
n1 <- length(df2$experimental)

ctrl_mean <- mean(df2$control,na.rm = TRUE)
ctrl_sd <- sd(df2$control,na.rm = TRUE)
n2 <- length(df2$control)-sum(is.na(df2$control))

Sc_2 <- ((n1-1)*e_sd^2+(n2-1)*ctrl_sd^2)/(n1+n2-2)

t2 <- (e_mean-ctrl_mean)/sqrt(Sc_2*(1/14+1/12))

t.test(df2$experimental,df2$control,var.equal = TRUE)

```

#### 方差是否相等------F检验

$$H_0:\frac{\sigma_1^2}{\sigma_2^2}=1$$

$$
F=\frac{\frac {(n_1-1)S_1^2}{\sigma_1^2}/(n_1-1)}{\frac {(n_2-1)S_2^2}{\sigma_2^2}/(n_2-1)}=(\frac{S_1^2}{S_2^2})(\frac{\sigma_2^2}{\sigma_1^2})=\frac{S_1^2}{S_2^2}\sim F(\nu_1,\nu_2),\nu_1=n_1-1,\nu_2=n_2-1
$$

```{r}
F_stats <- (e_sd^2)/(ctrl_sd^2)

# 检验两个样本的方差是否相等
var.test(df2$experimental,df2$control)

```

#### 方差不等------ Approximation t 检验

$$H_0:\mu_1-\mu_2=0$$

$$
t'=\frac{(\bar X_1-\bar X_2)-(\mu_1-\mu_2)}{\sqrt{\frac{S_1^2}{n_1}+\frac{S_2^2}{n_2}}}=\frac{\bar X_1-\bar X_2}{\sqrt{\frac{S_1^2}{n_1}+\frac{S_2^2}{n_2}}}\sim t(\nu ')
$$

##### Cochran & Cox Approximation t-test

强调方差的变异

因为$t'$既不遵循t分布，也不遵循正态分布，因此t'的临界值需要特定的计算方法。

$$
t'_{\alpha/2}=\frac{S^2_{\bar X_1}t_{\nu_1,\alpha/2}+S^2_{\bar X_2}t_{\nu_2,\alpha/2}}{S^2_{\bar X_1}+S^2_{\bar X_2}}
$$

$$
t'_{1-\alpha/2}=\frac{S^2_{\bar X_1}t_{\nu_1,1-\alpha/2}+S^2_{\bar X_2}t_{\nu_2,1-\alpha/2}}{S^2_{\bar X_1}+S^2_{\bar X_2}}
$$ 其中$\nu_1=n_1-1,\nu_2=n_2-1,t_{\nu_1,1-\alpha/2}和t_{\nu_2,1-\alpha/2}$分别是$t_{\nu_1}和t_{\nu_2}$的临界值。

因为t分布是对称的，$t_{\nu,\alpha/2}=-t_{\nu,1-\alpha/2}$，所以$t'_{\alpha/2}=t'_{1-\alpha/2}$。

##### Satterthwaite Approximation t-test

强调自由度

$$
v'=\frac{(\frac{S_1^2}{n_1}+\frac{S_2^2}{n_2})^2}{\frac{(\frac{S_1^2}{n_1})^2}{n_1-1}+\frac{(\frac{S_2^2}{n_2})^2}{n_2-1}}(舍入到最近整数)
$$

#### 大样本量------ Z检验

当$n_1＞30\ \&\ n_2＞30$时，

$$
\bar X_1\dot\sim N(\mu_1,\frac{\sigma^2_1}{n_1})
$$

$$
\bar X_2\dot\sim N(\mu_2,\frac{\sigma^2_2}{n_2})
$$

$$H_0:\mu_1-\mu_2=0$$

$$
Z=\frac{(\bar X_1-\bar X_2)-(\mu_1-\mu_2)}{\sqrt{\frac{\sigma^2_1}{n_1}+\frac{\sigma^2_2}{n_2}}}=\frac{\bar X_1-\bar X_2}{\sqrt{\frac{\sigma^2_1}{n_1}+\frac{\sigma^2_2}{n_2}}}\dot\sim N(0,1)
$$

#### 功效分析

功效(power) $1-β\approx\Phi(-z_{1-\alpha/2}+\frac{|\mu_1-\mu_2|}{\sqrt {\sigma_1^2/n_1+\sigma_2^2/n_2}})$

样本量

1.  两组样本量相等 $$
    n=\frac{(\sigma_1^2+\sigma_1^2)(z_{1-\alpha/2}+z_{1-\beta})^2}{(\mu_1-\mu_2)^2}
    $$

2.  两组样本量不等（$n_2=kn_1$） $$
    n_1=\frac{(\sigma_1^2+\sigma_1^2/k)(z_{1-\alpha/2}+z_{1-\beta})^2}{(\mu_1-\mu_2)^2}
    $$

    $$
    n_2=\frac{(k\sigma_1^2+\sigma_1^2)(z_{1-\alpha/2}+z_{1-\beta})^2}{(\mu_1-\mu_2)^2}
    $$

### 两总体率的差异------z检验

当$n_ip_i(1-p_i)≥5,(i=1,2)$时，$p_i\dot\sim N(\pi_i,\frac{\pi_i(1-\pi_i)}{n_i})$

$$
(p_1-p_2)\dot\sim N(\pi_1-\pi_2,\frac{\pi_1(1-\pi_1)}{n_1}+\frac{\pi_2(1-\pi_2)}{n_2})
$$

$H_0:\pi_1=\pi_2$

$$
Z=\frac{(p_1-p_2)-(\pi_1-\pi_2)}{S_{p_1-p_2}}=\frac{p_1-p_2}{\sqrt{p_C(1-p_C)(\frac{1}{n_1}+\frac{1}{n_2})}}\dot\sim N(0,1)
$$

其中$p_C=\frac{n_1p_1+n_2p_2}{n_1+n_2}$

功效分析

1.  $1-\beta$
2.  $n1,n_2=kn_1$
